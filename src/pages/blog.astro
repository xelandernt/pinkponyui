---
import BaseHead from '../components/BaseHead.astro';
import BlogSection from '../components/BlogSection.astro';
import NavCircle from '../components/NavCircle.astro';
import Footer from '../components/Footer.astro';
import { getCollection } from 'astro:content';
import { SITE_TITLE } from "../consts";
import '../styles/index.css';

// Get all blog posts from content collection and sort by order
const allPosts = await getCollection('blog');
const sortedPosts = allPosts.sort((a, b) => (a.data.order ?? 0) - (b.data.order ?? 0));

// Render all blog posts
const renderedPosts = await Promise.all(
	sortedPosts.map(async (post) => ({
		...post,
		Content: (await post.render()).Content
	}))
);
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={`Blog - ${SITE_TITLE}`} description="Read the latest from Pink Pony Running Club" />
	</head>
	<body>
		<div class="page-wrapper">
			<NavCircle position="top-left" href="/" text="Home" />
			<BlogSection renderedPosts={renderedPosts} />
			<Footer />
		</div>

		<script>
			import { gsap } from 'gsap';

			document.addEventListener('DOMContentLoaded', () => {
				// Animate blog entries sliding in from alternating sides
				const blogEntries = document.querySelectorAll('.blog-entry-wrapper');
				
				blogEntries.forEach((entry, index) => {
					const fromLeft = index % 2 === 0;
					const delay = index * 0.15;
					
					gsap.fromTo(entry,
						{
							x: fromLeft ? '-100%' : '100%',
							opacity: 0
						},
						{
							x: '0%',
							opacity: 1,
							duration: 0.5,
							delay: delay,
							ease: 'power2.out'
						}
					);
				});

				// Add click handlers for expanding/collapsing blog entries
				const blogCards = document.querySelectorAll('.blog-entry');
				let expandedCard = null;

				blogCards.forEach((card) => {
					card.addEventListener('click', () => {
						const isExpanded = card.getAttribute('data-expanded') === 'true';
						
						// Collapse previously expanded card
						if (expandedCard && expandedCard !== card) {
							expandedCard.setAttribute('data-expanded', 'false');
						}

						// Toggle current card
						if (isExpanded) {
							card.setAttribute('data-expanded', 'false');
							expandedCard = null;
						} else {
							card.setAttribute('data-expanded', 'true');
							expandedCard = card;
							
							// Scroll the card into view after a brief delay to allow content to expand
							setTimeout(() => {
								card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
							}, 100);
						}
					});
				});

				// Add hover effect for blog entries
				const blogContainer = document.querySelector('.blog-container');
				
				if (blogContainer) {
					blogCards.forEach((card) => {
						card.addEventListener('mouseenter', () => {
							const isExpanded = card.getAttribute('data-expanded') === 'true';
							
							if (!isExpanded) {
								gsap.to(card, {
									scale: 1.02,
									y: -5,
									duration: 0.3,
									ease: 'power2.out'
								});
							}
						});
						
						card.addEventListener('mouseleave', () => {
							const isExpanded = card.getAttribute('data-expanded') === 'true';
							
							if (!isExpanded) {
								gsap.to(card, {
									scale: 1,
									y: 0,
									duration: 0.3,
									ease: 'power2.out'
								});
							}
						});
					});
				}
			});
		</script>

		<script>
			// Auto-hide scrollbar functionality
			document.addEventListener('DOMContentLoaded', () => {
				const pageWrapper = document.querySelector('.page-wrapper');
				if (!pageWrapper) return;

				let scrollTimeout;
				let mouseTimeout;
				const HIDE_DELAY = 1500; // Hide scrollbar after 1.5 seconds of inactivity
				const EDGE_THRESHOLD = 30; // Show scrollbar when mouse is within 30px of right edge

				// Initially hide the scrollbar
				pageWrapper.classList.add('scrollbar-hidden');

				// Show scrollbar
				function showScrollbar() {
					pageWrapper.classList.remove('scrollbar-hidden');
				}

				// Hide scrollbar with delay
				function hideScrollbar() {
					pageWrapper.classList.add('scrollbar-hidden');
				}

				// Show scrollbar on scroll and hide after delay
				pageWrapper.addEventListener('scroll', () => {
					showScrollbar();
					clearTimeout(scrollTimeout);
					scrollTimeout = setTimeout(hideScrollbar, HIDE_DELAY);
				});

				// Show scrollbar when hovering near right edge
				document.addEventListener('mousemove', (e) => {
					const distanceFromRight = window.innerWidth - e.clientX;
					
					if (distanceFromRight <= EDGE_THRESHOLD) {
						showScrollbar();
						clearTimeout(mouseTimeout);
					} else {
						clearTimeout(mouseTimeout);
						mouseTimeout = setTimeout(hideScrollbar, HIDE_DELAY);
					}
				});

				// Hide scrollbar when mouse leaves the window
				document.addEventListener('mouseleave', () => {
					clearTimeout(mouseTimeout);
					mouseTimeout = setTimeout(hideScrollbar, HIDE_DELAY);
				});
			});
		</script>
	</body>
</html>
